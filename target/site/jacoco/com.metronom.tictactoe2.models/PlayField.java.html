<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayField.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TicTacToe2</a> &gt; <a href="index.source.html" class="el_package">com.metronom.tictactoe2.models</a> &gt; <span class="el_source">PlayField.java</span></div><h1>PlayField.java</h1><pre class="source lang-java linenums">package com.metronom.tictactoe2.models;

import com.metronom.tictactoe2.console.ConsoleMessage;
import com.metronom.tictactoe2.exceptions.InvalidCellException;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collector;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class PlayField {
    

<span class="fc" id="L22">	private static PlayField instance = new PlayField();</span>

    private Character[][] table;
    private int freeRoomCount;
    private int playFieldSize;
    private List&lt;BigInteger&gt; winningPatterns;
    
    // Block Initialization
    private PlayField() {
    }
    
    
    /*
     * GETTER AND SETTERS
     * 
     */
    
    public static PlayField getInstance() {
<span class="fc" id="L40">        return instance;</span>
    }
    
    public Character[][] getTable() {
<span class="nc" id="L44">		return table;</span>
	}
    
    private void setWinningPatterns(List&lt;BigInteger&gt; pat) {
<span class="fc" id="L48">		this.winningPatterns = pat;</span>
		
<span class="fc" id="L50">	}</span>
    
    public List&lt;BigInteger&gt; getWinningPatterns() {
<span class="nc" id="L53">		return winningPatterns;</span>
	}
    
    /**
     * Gives the free room count in the board.
     *
     * @return {@code freeRoomCount}
     */
    public int getFreeRoomCount() {
<span class="fc" id="L62">        return freeRoomCount;</span>
    }

    /**
     * Gives the board length.
     *
     * @return {@code playFieldSize}
     */
    public int getPlayFieldLength() {
<span class="fc" id="L71">        return playFieldSize;</span>
    }
    
    List&lt;List&lt;Integer&gt;&gt; getBlankTable(){
<span class="fc" id="L75">    	List&lt;List&lt;Integer&gt;&gt; pat =  new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">    	for(int i=0; i &lt; playFieldSize;i++) {</span>
<span class="fc" id="L77">    		List&lt;Integer&gt; rowlist = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">    		for(int j=0;j&lt;playFieldSize;j++) {</span>
<span class="fc" id="L79">    			rowlist.add(0);</span>
    		}
<span class="fc" id="L81">    		pat.add(rowlist);</span>
    	}
<span class="fc" id="L83">    	return pat; </span>
    }
    
    /**
     * Puts a character in the {@code cell} location of the board.
     *
     * @param value      the character to put on board
     * @param cell location to put the character
     * @throws InvalidCellException if the {@code cell} is not in the boards length or the cell
     *                                    is already full.
     */
    public void put(final Character value, final Cell cell) throws InvalidCellException {
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (!isInRange(cell.getRow(), cell.getColumn()))</span>
<span class="fc" id="L96">            throw new InvalidCellException(String.format(ConsoleMessage.INVALID_POINT.getMessageText(), playFieldSize, playFieldSize));</span>

<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (table[cell.getRow()][cell.getColumn()] != null)</span>
<span class="fc" id="L99">            throw new InvalidCellException(ConsoleMessage.CELL_ALREADY_FULL.getMessageText());</span>

<span class="fc" id="L101">        table[cell.getRow()][cell.getColumn()] = value;</span>
<span class="fc" id="L102">        freeRoomCount--;</span>
<span class="fc" id="L103">    }</span>

    
    /**
     * Initializes the board by setting the {@code playFieldSize} and instantiating the board {@code table} and setting
     * the {@code freeRoomCount}.
     *
     * @param playFieldSize length of the board
     */
    public void init(int playFieldSize) {
<span class="fc" id="L113">        this.playFieldSize = playFieldSize;</span>
<span class="fc" id="L114">        this.table = new Character[playFieldSize][playFieldSize];</span>
<span class="fc" id="L115">        this.freeRoomCount = playFieldSize * playFieldSize;</span>
<span class="fc" id="L116">    }</span>
    
    /*
     * Creates all possible winning patterns in binary 1,0 -
     * 
     * | x | x | x |
     * |   |   |   |  =&gt; one example of winning pattern (111000000)
     * |   |   |   |
     * 
     * | x |   |   |
     * | x |   |   |  =&gt; one example of winning pattern (100100100)
     * | x |   |   |
     * 
     * 
     */
    public void populateWinningPatterns() {
    	
<span class="fc" id="L133">    	List&lt;String&gt; patterns = new ArrayList&lt;String&gt;();</span>
    	
    	//populate row patterns
<span class="fc bfc" id="L136" title="All 2 branches covered.">    	for(int i=0; i &lt; playFieldSize;i++) {</span>
<span class="fc" id="L137">    		List&lt;List&lt;Integer&gt;&gt; table = getBlankTable();</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">    		for(int j=0;j&lt;playFieldSize;j++) {</span>
<span class="fc" id="L139">    			table.get(i).set(j, 1);</span>
    		}
<span class="fc" id="L141">    		String pattern = table.stream().flatMap(Collection::stream).map(n -&gt; n.toString()).collect(Collectors.joining(&quot;&quot;));</span>
<span class="fc" id="L142">    		patterns.add(pattern);</span>
    	}
    	
    	//populate column patterns
<span class="fc bfc" id="L146" title="All 2 branches covered.">    	for(int i=0; i &lt; playFieldSize;i++) {</span>
<span class="fc" id="L147">    		List&lt;List&lt;Integer&gt;&gt; table = getBlankTable();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">    		for(int j=0;j&lt;playFieldSize;j++) {</span>
<span class="fc" id="L149">    			table.get(j).set(i, 1);</span>
    		}
<span class="fc" id="L151">    		String pattern = table.stream().flatMap(Collection::stream).map(n -&gt; n.toString()).collect(Collectors.joining(&quot;&quot;));</span>
<span class="fc" id="L152">    		patterns.add(pattern);		</span>
    	}
    	
    	//populate diagonal pattern
<span class="fc" id="L156">    	List&lt;List&lt;Integer&gt;&gt; diagonalTable = getBlankTable();</span>
<span class="fc" id="L157">    	List&lt;List&lt;Integer&gt;&gt; diagonalAlternateTable = getBlankTable();</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">    	for(int j=0; j&lt; playFieldSize; j++) {</span>
<span class="fc" id="L159">    		diagonalTable.get(j).set(j,1);</span>
<span class="fc" id="L160">    		diagonalAlternateTable.get(j).set((playFieldSize-1)-j,1);</span>
    	}
<span class="fc" id="L162">    	String diagonalPattern = diagonalTable.stream().flatMap(Collection::stream).map(n -&gt; n.toString()).collect(Collectors.joining(&quot;&quot;));</span>
<span class="fc" id="L163">    	String alternatediagonalPattern = diagonalAlternateTable.stream().flatMap(Collection::stream).map(n -&gt; n.toString()).collect(Collectors.joining(&quot;&quot;));</span>
<span class="fc" id="L164">    	patterns.add(diagonalPattern);</span>
<span class="fc" id="L165">    	patterns.add(alternatediagonalPattern);</span>
    	
<span class="fc" id="L167">    	List&lt;BigInteger&gt; pat = patterns.stream().map(n -&gt; new BigInteger(n,2)).collect(Collectors.toList());</span>
		  		
<span class="fc" id="L169">    	this.setWinningPatterns(pat);</span>
    	
<span class="fc" id="L171">    }</span>
    
    
    /**
     * Return heuristic score for each row columns and diagonal
     * @param table
     * @param mySymbol
     * @return {@link int} score
     */
    public int evaluate(Character[][] table, char mySymbol) {
<span class="nc" id="L181">        int rowScore = 0;</span>
        
        //evaluate row scores
<span class="nc bnc" id="L184" title="All 2 branches missed.">        for(int i=0; i &lt; playFieldSize;i++) {</span>
<span class="nc" id="L185">        	boolean first = true;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">    		for(int j=0;j&lt;playFieldSize;j++) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    			if(first) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">    				if(table[i][j]!=null) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">					if(table[i][j] == mySymbol) {</span>
<span class="nc" id="L190">						rowScore = 1;</span>
					}else {
<span class="nc" id="L192">						rowScore = -1;</span>
					}
<span class="nc" id="L194">    				first = false;</span>
    				}
    			}else {
<span class="nc bnc" id="L197" title="All 2 branches missed.">    				if(table[i][j]!=null) {</span>
    					
<span class="nc bnc" id="L199" title="All 2 branches missed.">    				if(table[i][j] == mySymbol) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    					if(rowScore &gt;= 1) {</span>
<span class="nc" id="L201">    						rowScore *= 10;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">    					}else if(rowScore &lt; 0) {</span>
<span class="nc" id="L203">    						rowScore = 0;</span>
    					}else {
<span class="nc" id="L205">    						rowScore = 1;</span>
    					}
    				}else {
<span class="nc bnc" id="L208" title="All 2 branches missed.">    					if(rowScore &lt; 0) {</span>
<span class="nc" id="L209">    						rowScore *= 10;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">    					}else if(rowScore &gt; 1) {</span>
<span class="nc" id="L211">    						rowScore = 0;</span>
    					}else {
<span class="nc" id="L213">    						rowScore = -1;</span>
    					}
    				}
    				}
    			}
    		}
  
    	}
        
        //evaluate column scores
<span class="nc" id="L223">        int colScore = 0;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        for(int i=0; i &lt; playFieldSize;i++) {</span>
<span class="nc" id="L225">        	boolean first =true;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    		for(int j=0;j&lt;playFieldSize;j++) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">    			if(first) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">    				if(table[j][i]==null) {</span>
<span class="nc" id="L229">    					colScore = -1;</span>
    				}
<span class="nc bnc" id="L231" title="All 2 branches missed.">    				else if(table[j][i] == mySymbol) {</span>
<span class="nc" id="L232">    					colScore = 1;</span>
    				}
<span class="nc" id="L234">    				first = false;</span>
    			}else {
<span class="nc bnc" id="L236" title="All 2 branches missed.">    				if(table[j][i]==null) {</span>
<span class="nc" id="L237">    					colScore = -1;</span>
    				}
<span class="nc bnc" id="L239" title="All 2 branches missed.">    				else if(table[j][i] == mySymbol) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">    					if(colScore &gt; 0) {</span>
<span class="nc" id="L241">    						colScore *= 10;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">    					}else if(colScore &lt; 0) {</span>
<span class="nc" id="L243">    						colScore = 0;</span>
    					}else {
<span class="nc" id="L245">    						colScore = 1;</span>
    					}
<span class="nc bnc" id="L247" title="All 2 branches missed.">    				}else if(table[j][i] != null) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">    					if(colScore &lt; 0) {</span>
<span class="nc" id="L249">    						colScore *= 10;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    					}else if(colScore &gt; 1) {</span>
<span class="nc" id="L251">    						colScore = 0;</span>
    					}else {
<span class="nc" id="L253">    						colScore = -1;</span>
    					}
    				}
    			}
    		}
  
    	}
        
<span class="nc" id="L261">        int diagonalScore = 0;</span>
<span class="nc" id="L262">        int alternateDiagonalScore = 0;</span>
<span class="nc" id="L263">        boolean diagonalFirst =true;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">    	for(int j=0; j&lt; playFieldSize; j++) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    		if(diagonalFirst) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">				if(table[j][j]==null) {</span>
<span class="nc" id="L267">					diagonalScore = -1;</span>
				}
<span class="nc bnc" id="L269" title="All 2 branches missed.">				else if(table[j][j] == mySymbol) {</span>
<span class="nc" id="L270">					diagonalScore = 1;</span>
				}
<span class="nc" id="L272">				diagonalFirst = false;</span>
			}else {
<span class="nc bnc" id="L274" title="All 2 branches missed.">				if(table[j][j]==null) {</span>
<span class="nc" id="L275">					diagonalScore = -1;</span>
				}
<span class="nc bnc" id="L277" title="All 2 branches missed.">				else if(table[j][j] == mySymbol) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">					if(diagonalScore &gt; 0) {</span>
<span class="nc" id="L279">						diagonalScore *= 10;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">					}else if(diagonalScore &lt; 0) {</span>
<span class="nc" id="L281">						diagonalScore = 0;</span>
					}else {
<span class="nc" id="L283">						diagonalScore = 1;</span>
					}
<span class="nc bnc" id="L285" title="All 2 branches missed.">				}else if(table[j][j] != null) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">					if(diagonalScore &lt; 0) {</span>
<span class="nc" id="L287">						diagonalScore *= 10;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">					}else if(diagonalScore &gt; 1) {</span>
<span class="nc" id="L289">						diagonalScore = 0;</span>
					}else {
<span class="nc" id="L291">						diagonalScore = -1;</span>
					}
				}
			}
    		
    		
    	}
<span class="nc" id="L298">    	boolean alternateDiagonalFirst =true;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">    	for(int j=0; j&lt; playFieldSize; j++) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">    		if(alternateDiagonalFirst) {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">				if(table[j][(playFieldSize-1)-j]==null) {</span>
<span class="nc" id="L302">					alternateDiagonalScore = -1;</span>
				}
<span class="nc bnc" id="L304" title="All 2 branches missed.">				else if(table[j][(playFieldSize-1)-j] == mySymbol) {</span>
<span class="nc" id="L305">					alternateDiagonalScore = 1;</span>
				}
<span class="nc" id="L307">				alternateDiagonalFirst = false;</span>
			}else {
<span class="nc bnc" id="L309" title="All 2 branches missed.">				if(table[j][(playFieldSize-1)-j]==null) {</span>
<span class="nc" id="L310">					alternateDiagonalScore = -1;</span>
				}
<span class="nc bnc" id="L312" title="All 2 branches missed.">				else if(table[j][(playFieldSize-1)-j] == mySymbol) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">					if(alternateDiagonalScore &gt; 0) {</span>
<span class="nc" id="L314">						alternateDiagonalScore *= 10;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">					}else if(alternateDiagonalScore &lt; 0) {</span>
<span class="nc" id="L316">						alternateDiagonalScore = 0;</span>
					}else {
<span class="nc" id="L318">						alternateDiagonalScore = 1;</span>
					}
<span class="nc bnc" id="L320" title="All 2 branches missed.">				}else if(table[j][(playFieldSize-1)-j] != null) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">					if(alternateDiagonalScore &lt; 0) {</span>
<span class="nc" id="L322">						alternateDiagonalScore *= 10;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">					}else if(alternateDiagonalScore &gt; 1) {</span>
<span class="nc" id="L324">						alternateDiagonalScore = 0;</span>
					}else {
<span class="nc" id="L326">						alternateDiagonalScore = -1;</span>
					}
				}
			}
    		
    	}
    	
<span class="nc" id="L333">    	int finalScore = rowScore+colScore+diagonalScore+alternateDiagonalScore;</span>
<span class="nc" id="L334">        return finalScore;</span>
     }

    /**
     * Calculates the horizontal score of the given cell. Assume that we have a {@code x}
     * at the location {@code {0, 0}} and we have another {@code x} at the location {@code {0, 1}}.
     * In this case, this method will return {@code 2} for both cells.
     *
     * @param cell the location of the board that we want to calculate it's horizontal score.
     * @return score of the given cell.
     */
    public int calculateHorizontalScore(final Cell cell) {
<span class="fc" id="L346">        return calculateScore(cell, 0, -1, 0, 1);</span>
    }

    /**
     * Calculates the vertical score of the given cell. Assume that we have a {@code x}
     * at the location {@code {0, 0}} and we have another {@code x} at the location {@code {1, 0}}.
     * In this case, this method will return {@code 2} for both cells.
     *
     * @param cell the location of the board that we want to calculate it's vertical score.
     * @return score of the given cell.
     */
    public int calculateVerticalScore(final Cell cell) {
<span class="fc" id="L358">        return calculateScore(cell, -1, 0, 1, 0);</span>
    }

    /**
     * Calculates the diagonal1 score of the given cell. Assume that we have a {@code x}
     * at the location {@code {0, 0}} and we have another {@code x} at the location {@code {1, 1}}.
     * In this case, this method will return {@code 2} for both cells.
     *
     * @param cell the location of the board that we want to calculate it's diagonal1 score.
     * @return score of the given cell.
     */
    public int calculateDiagonal1Score(final Cell cell) {
<span class="fc" id="L370">        return calculateScore(cell, -1, -1, 1, 1);</span>
    }

    /**
     * Calculates the diagonal2 score of the given cell. Assume that we have a {@code x}
     * at the location {@code {0, 1}} and we have another {@code x} at the location {@code {1, 0}}.
     * In this case, this method will return {@code 2} for both cells.
     *
     * @param cell the location of the board that we want to calculate it's diagonal2 score.
     * @return score of the given cell.
     */
    public int calculateDiagonal2Score(final Cell cell) {
<span class="fc" id="L382">        return calculateScore(cell, -1, 1, 1, -1);</span>
    }

    /**
     * Gives the value of the given cell as an {@code Optional&lt;Character&gt;}.
     * This method will return {@code Optional.empty} if the location is empty or
     * if the given cell is not in the range of the board.
     *
     * @param row    row number of the board
     * @param column column number of the board
     * @return {@code Optional&lt;Character&gt;}
     */
    public Optional&lt;Character&gt; getCell(final int row, final int column) {
<span class="fc bfc" id="L395" title="All 2 branches covered.">        if (isInRange(row, column))</span>
<span class="fc" id="L396">            return Optional.ofNullable(table[row][column]);</span>

<span class="fc" id="L398">        return Optional.empty();</span>
    }

    /**
     * Indicates that, the given cell is inside the board or not.
     *
     * @param row    row number
     * @param column column number
     * @return {@code true} if the cell is inside the board and otherwise {@code false}
     */
    private boolean isInRange(int row, int column) {
<span class="fc bfc" id="L409" title="All 8 branches covered.">        return row &gt;= 0 &amp;&amp; column &gt;= 0 &amp;&amp; row &lt; playFieldSize &amp;&amp; column &lt; playFieldSize;</span>
    }

    /**
     * This is the main method for calculating the score of a cell in any direction.
     * We can specify the direction using the input parameters.
     * &lt;br/&gt;&lt;br/&gt;
     * We have 4 {@code int} parameters that first two parameters specify that when we want to find the start of
     * the line, in which direction we have to move.
     * The next two parameters specify that when we want to find
     * the end of the line, in which direction we have to move.
     *
     * @param cell     the base cell which we want to calculate the score based on that
     * @param startRowInc    the amount of row increment when we want to move toward the start of the line
     * @param startColumnInc the amount of column increment when we want to move toward the start of the line
     * @param endRowInc      the amount of row increment when we want to move toward the end of the line
     * @param endColumnInc   the amount of column increment when we want to move toward the end of the line
     * @return a number equals or greater than 0 that indicates the score of the given cell
     * using the given direction.
     */
    private int calculateScore(final Cell cell, final int startRowInc, final int startColumnInc, final int endRowInc, final int endColumnInc) {
<span class="fc" id="L430">        int startRow = cell.getRow();</span>
<span class="fc" id="L431">        int startColumn = cell.getColumn();</span>
<span class="fc" id="L432">        int endRow = cell.getRow();</span>
<span class="fc" id="L433">        int endColumn = cell.getColumn();</span>

<span class="fc" id="L435">        final Optional&lt;Character&gt; cellValue = getCell(cell.getRow(), cell.getColumn());</span>

<span class="fc bfc" id="L437" title="All 2 branches covered.">        if (cellValue.isPresent()) {</span>
            // Finding the start of the line
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">            while (isInRange(startRow, startColumn)) {</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">                if (cellValue.equals(getCell(startRow + startRowInc, startColumn + startColumnInc))) {</span>
<span class="fc" id="L441">                    startRow += startRowInc;</span>
<span class="fc" id="L442">                    startColumn += startColumnInc;</span>
                } else break;
            }

            // Finding the end of the line
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">            while (isInRange(endRow, endColumn)) {</span>
<span class="fc bfc" id="L448" title="All 2 branches covered.">                if (cellValue.equals(getCell(endRow + endRowInc, endColumn + endColumnInc))) {</span>
<span class="fc" id="L449">                    endRow += endRowInc;</span>
<span class="fc" id="L450">                    endColumn += endColumnInc;</span>
                } else break;
            }

<span class="fc" id="L454">            return Math.max(endRow - startRow + 1, endColumn - startColumn + 1);</span>
        }

<span class="fc" id="L457">        return 0;</span>
    }
    

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>