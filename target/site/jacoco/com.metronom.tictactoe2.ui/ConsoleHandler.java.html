<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConsoleHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TicTacToe2</a> &gt; <a href="index.source.html" class="el_package">com.metronom.tictactoe2.ui</a> &gt; <span class="el_source">ConsoleHandler.java</span></div><h1>ConsoleHandler.java</h1><pre class="source lang-java linenums">package com.metronom.tictactoe2.ui;

import com.metronom.tictactoe2.config.Params;
import com.metronom.tictactoe2.core.PlayEngine;
import com.metronom.tictactoe2.models.PlayRuntimeStatus;
import com.metronom.tictactoe2.models.Cell;
import com.metronom.tictactoe2.models.Player;
import com.metronom.tictactoe2.exceptions.InvalidCellException;
import com.metronom.tictactoe2.ui.ConsoleMessage;

import java.io.PrintStream;
import java.io.Reader;
import java.util.HashSet;
import java.util.Scanner;
import java.util.Set;

public class ConsoleHandler {
	
	// Singleton Instance
<span class="fc" id="L20">    private static ConsoleHandler instance = new ConsoleHandler();</span>
    
<span class="fc" id="L22">    private final int minPlayFieldSize = 3;</span>
<span class="fc" id="L23">    private final int maxPlayFieldSize = 10;</span>

    private Scanner scanner;
    private PrintStream messagesOutput;
    private PrintStream errorsOutput;
<span class="fc" id="L28">    private Set&lt;Character&gt; symbols = new HashSet&lt;&gt;();</span>
	private PlayEngine playEngine;
    
<span class="fc" id="L31">    ConsoleHandler() {</span>
<span class="fc" id="L32">    }</span>

    // Get ConsoleReader singleton instance
    public static ConsoleHandler getInstance() {
<span class="fc" id="L36">        return instance;</span>
    }
    
    public void initialize(Reader usersInput, PrintStream messagesOutput, PrintStream errorsOutput) {
<span class="nc" id="L40">    	this.scanner = new Scanner(usersInput);</span>
<span class="nc" id="L41">        this.messagesOutput = messagesOutput;</span>
<span class="nc" id="L42">        this.errorsOutput = errorsOutput;</span>
<span class="nc" id="L43">    }</span>
    
    public void setPlayEngine(PlayEngine playEngine) {
<span class="nc" id="L46">    	this.playEngine= playEngine;</span>
<span class="nc" id="L47">    }</span>

    /**
     * Starts the main loop for users interaction.
     * &lt;br/&gt;&lt;br/&gt;
     * This method starts the playEngine and inside a loop, takes the users input and
     * puts them inside the board using the {@link Game}'s {@code performAction} method.
     * After that, last move's data will be shown and the playEngine status will be shown.
     * &lt;br/&gt;&lt;br/&gt;
     * This loop runs while the playEngine status is {@code PlayRuntimeStatus.ON}
     */
    public void startGame() {
<span class="nc" id="L59">        showStatus();</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        while (playEngine.getStatus() == PlayRuntimeStatus.ON) {</span>
<span class="nc" id="L62">            Player player = playEngine.getNextPlayer();</span>

            try {
<span class="nc" id="L65">                Cell cell = player.getNextMove(playEngine.getPlayField()).orElseGet(() -&gt; readPlayerMoves(player));</span>

<span class="nc" id="L67">                playEngine.performAction(cell);</span>
<span class="nc" id="L68">                showMessage(String.format(ConsoleMessage.PLAYER_INPUT.getMessageText(), player.getName(), cell.getRow() + 1, cell.getColumn() + 1));</span>
<span class="nc" id="L69">                showStatus();</span>
<span class="nc" id="L70">            } catch (InvalidCellException ex) {</span>
<span class="nc" id="L71">                showError(ex.getMessage());</span>
            }
        }
<span class="nc" id="L74">    }</span>
    
    /**
     * Writes a message to UI's message {@link PrintStream}
     * and waits for flush to avoid interference with other messages.
     *
     * @param message the message to show to the user
     */
    private void showMessage(String message) {
<span class="nc" id="L83">        messagesOutput.println(message);</span>
<span class="nc" id="L84">        messagesOutput.flush();</span>
<span class="nc" id="L85">        waitForFlush();</span>
<span class="nc" id="L86">    }</span>
    
    /**
     * Writes an error to UI's error {@link PrintStream}
     * and waits for flush to avoid interference with other messages.
     *
     * @param error the error to show to the user
     */
    private void showError(String error) {
<span class="nc" id="L95">        errorsOutput.println(error);</span>
<span class="nc" id="L96">        errorsOutput.flush();</span>
<span class="nc" id="L97">        waitForFlush();</span>
<span class="nc" id="L98">    }</span>

    /**
     * Simply sleeps for 10 milliseconds
     */
    private void waitForFlush() {
        try {
<span class="nc" id="L105">            Thread.sleep(10);</span>
<span class="nc" id="L106">        } catch (Exception ignored) { }</span>
<span class="nc" id="L107">    }</span>

    /**
     * Shows the running playEngine configs to user
     */
    private void showConfigs() {
<span class="nc" id="L113">        Params config = playEngine.getParams();</span>
<span class="nc" id="L114">        String msg = String.format(</span>
<span class="nc" id="L115">        		ConsoleMessage.CONFIGS.getMessageText(), </span>
<span class="nc" id="L116">        		config.getPlayFieldSize(),</span>
<span class="nc" id="L117">        		config.getPlayerOneSymbol(), </span>
<span class="nc" id="L118">        		config.getPlayerTwoSymbol(), </span>
<span class="nc" id="L119">        		config.getAIPlayerSymbol()</span>
        		);
<span class="nc" id="L121">        showMessage(msg);</span>
<span class="nc" id="L122">    }</span>

    /**
     * Shows the playEngine status and the whole board to user
     */
    private void showStatus() {
<span class="nc" id="L128">        showMessage(String.format(ConsoleMessage.GAME_STATUS.getMessageText(), playEngine.getStatus().getStatus()));</span>
<span class="nc" id="L129">        playEngine.getWinner().ifPresent(winner -&gt; showMessage(String.format(ConsoleMessage.WINNER.getMessageText(), winner.getName(), winner.getSymbol())));</span>
<span class="nc" id="L130">        StringBuilder sb = new StringBuilder();</span>
        
<span class="nc bnc" id="L132" title="All 2 branches missed.">        for (int row = -1; row &lt; playEngine.getPlayField().getPlayFieldLength(); row++) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            for (int column = -1; column &lt; playEngine.getPlayField().getPlayFieldLength(); column++) {</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">                if (row == -1 &amp;&amp; column &gt; -1)</span>
<span class="nc" id="L135">                    sb.append(&quot; &quot;+ (column + 1)+ &quot; &quot;);</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">                else if (column == -1 &amp;&amp; row &gt; -1)</span>
<span class="nc" id="L137">                    sb.append(&quot; &quot;+ (row + 1)+ &quot; &quot;);</span>
<span class="nc" id="L138">                else sb.append(&quot; &quot;+playEngine.getPlayField().getCell(row, column).orElse(' ')+&quot; &quot;);</span>

<span class="nc" id="L140">                sb.append(&quot; | &quot;);</span>
            }

<span class="nc" id="L143">            sb.append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L145">        showMessage(sb.toString());</span>
<span class="nc" id="L146">    }</span>
    
    public int readPlayFieldSize() {
<span class="nc" id="L149">    	boolean status = false;</span>
<span class="nc" id="L150">    	int size=0;</span>
    	
    	
<span class="nc" id="L153">    	showMessage(ConsoleMessage.ENTER_PLAYFIELD_SIZE.getMessageText());</span>
    	
<span class="nc bnc" id="L155" title="All 2 branches missed.">    	while (!status) {</span>
    		
<span class="nc bnc" id="L157" title="All 2 branches missed.">    		while (!scanner.hasNextInt()) {</span>
<span class="nc" id="L158">                String input = scanner.next();</span>
<span class="nc" id="L159">                showMessage(String.format(ConsoleMessage.WRONG_VALUE.getMessageText(),input));</span>
            }
<span class="nc" id="L161">    		size = scanner.nextInt();</span>
<span class="nc" id="L162">    		status = validatePlayFieldSize(size);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        	if(!status) showMessage(ConsoleMessage.INVALID_BOARD_LENGTH.getMessageText());</span>
    	}
<span class="nc" id="L165">    	return size;</span>
    }
    
    public char readPlayerSymbol(String playerName) {
<span class="nc" id="L169">    	char symbol = 0;</span>
<span class="nc" id="L170">    	boolean ok = false;</span>
<span class="nc" id="L171">    	showMessage(String.format(ConsoleMessage.ENTER_PLAYER_SYMBOL.getMessageText(), playerName));</span>
    		
<span class="nc bnc" id="L173" title="All 2 branches missed.">		while (!ok) {</span>
<span class="nc" id="L174">	        symbol = scanner.next().charAt(0);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">	        if(symbols.contains(Character.toLowerCase(symbol))) {</span>
<span class="nc" id="L176">	        	showMessage(ConsoleMessage.SYMBOL_ALREADY_CHOSEN.getMessageText());</span>
<span class="nc" id="L177">	        	continue;</span>
	        }
<span class="nc bnc" id="L179" title="All 2 branches missed.">	        if (!Character.isLetter(symbol)) {</span>
<span class="nc" id="L180">	        	showMessage(String.format(ConsoleMessage.WRONG_VALUE.getMessageText(), symbol));</span>
<span class="nc" id="L181">	        	continue;</span>
	        }
<span class="nc" id="L183">	        ok = true;</span>
	    }
<span class="nc" id="L185">    	symbols.add(Character.toLowerCase(symbol));</span>
<span class="nc" id="L186">    	return symbol;</span>
	}
    
    private boolean validatePlayFieldSize(int size) {
    	
<span class="nc bnc" id="L191" title="All 4 branches missed.">    	boolean isValid = size &lt;= maxPlayFieldSize &amp;&amp; size &gt;= minPlayFieldSize? true: false;</span>
<span class="nc" id="L192">    	return isValid;</span>
    }

    /**
     * Reads user input from command line interface. This method keeps prompting the user while
     * the input value is not valid.
     *
     * @param player the player that should give the next input
     * @return next {@link Coordinate} given by the player
     */
    private Cell readPlayerMoves(Player player) {
<span class="nc" id="L203">        Cell cell = null;</span>
        String response;

<span class="nc bnc" id="L206" title="All 2 branches missed.">        while (cell == null) {</span>
<span class="nc" id="L207">            showMessage(String.format(ConsoleMessage.ENTER_NEXT_POINT.getMessageText(), player.getName(), player.getSymbol()));</span>
            
        	
<span class="nc" id="L210">            String location = scanner.nextLine();</span>
            
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (location.isEmpty()) location = scanner.nextLine();</span>
            
        	try {
<span class="nc" id="L215">        		int x = Character.getNumericValue(location.charAt(0));</span>
<span class="nc" id="L216">        		char sep = location.charAt(1);</span>
<span class="nc" id="L217">        		int y = Character.getNumericValue(location.charAt(2));</span>
        		
        		
<span class="nc bnc" id="L220" title="All 4 branches missed.">	        	boolean isValidX = x &gt;= 1 &amp;&amp; x &lt;= maxPlayFieldSize? true: false;</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">	        	boolean isValidY = y &gt;= 1 &amp;&amp; y &lt;= maxPlayFieldSize? true: false;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">	        	boolean isValidSep = sep == ','? true: false;</span>
	        	
<span class="nc bnc" id="L224" title="All 6 branches missed.">	        	if (isValidX &amp;&amp; isValidY &amp;&amp; isValidSep) {</span>
	        	
<span class="nc" id="L226">		            int row = x - 1;</span>
<span class="nc" id="L227">		            int column = y - 1;</span>
<span class="nc" id="L228">		            cell = new Cell(row, column);</span>
<span class="nc" id="L229">	        	}else {</span>
<span class="nc" id="L230">	        		showMessage(String.format(ConsoleMessage.WRONG_VALUE.getMessageText(), location));</span>
	        	}
	        	
<span class="nc" id="L233">        	}catch(StringIndexOutOfBoundsException e) {</span>
<span class="nc" id="L234">        		showMessage(String.format(ConsoleMessage.WRONG_VALUE.getMessageText(), location));</span>
        	}
        	
            
        }

<span class="nc" id="L240">        return cell;</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>